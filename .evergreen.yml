stepback: false
exec_timeout_secs: 1800

functions:
  'prepare':
    - command: git.get_project
      params:
        directory: src
    - command: shell.exec
      params:
        working_dir: src
        script: |
          set -ev
          echo "Setting up ./compass_env.sh"

          cat <<EOF_BUILD_SH > ./compass_env.sh
          set -e
          export CI=1
          export EVERGREEN=1

          # Make default evergreen expansions accessible to hadron-build
          export EVERGREEN_ASSET_PREFIX="s3://mciuploads/${project}/${revision}";
          export EVERGREEN_AUTHOR="${author}";
          export EVERGREEN_AWS_ACCESS_KEY_ID="${aws_key}";
          export EVERGREEN_AWS_SECRET_ACCESS_KEY="${aws_secret}";
          export EVERGREEN_BRANCH_NAME="${branch_name}";
          export EVERGREEN_BUILD_ID="${build_id}";
          export EVERGREEN_BUILD_VARIANT="${build_variant}";
          export EVERGREEN_EXECUTION="${execution}";
          export EVERGREEN_IS_PATCH=${is_patch};
          export EVERGREEN_PROJECT="${project}";
          export EVERGREEN_REVISION="${revision}";
          export EVERGREEN_TASK_ID="${task_id}";
          export EVERGREEN_TASK_NAME="${task_name}";
          export EVERGREEN_TASK_URL="https://evergreen.mongodb.com/task/${task_id}";
          export EVERGREEN_VERSION_ID="${version_id}";
          export EVERGREEN_WORKDIR="${workdir}";

          # node stuff
          export ARTIFACTS_PATH="$(pwd)/.deps"
          export NPM_CACHE_DIR="$(pwd)/.deps/npm"
          export NPM_TMP_DIR="$(pwd)/.deps/tmp"
          export NPM_AUTH_TOKEN="${compass_npm_token}"

          export NODE_JS_VERSION="8.9.3"
          echo "OSTYPE: $OSTYPE"
          echo "uname: `uname`"
          # OS detection
          if [[ "$OSTYPE" == "msys" ]]; then
              export PLATFORM='win32'
              export IS_WINDOWS=true
          elif [[ "$OSTYPE" == "cygwin" ]]; then
              export PLATFORM='win32'
              export IS_WINDOWS=true
          elif [[ `uname` == "Darwin" ]]; then
              export PLATFORM='darwin'
              export IS_OSX=true
          else
              export PLATFORM='linux'
              if cat /etc/*release | grep ^NAME | grep Red; then
                  export IS_RHEL=true
              elif cat /etc/*release | grep ^NAME | grep Ubuntu; then
                  export IS_UBUNTU=true
              fi
          fi

          if [ -n "$IS_WINDOWS" ]; then
            export PATH="$(pwd)/.deps:$PATH"
            export APPDATA='Z:\'
          else
            export PATH="$(pwd)/.deps/bin:$PATH"
          fi

          EOF_BUILD_SH

          . ./compass_env.sh

          # Make all the dirs
          mkdir -p $ARTIFACTS_PATH
          mkdir -p $NPM_CACHE_DIR
          mkdir -p $NPM_TMP_DIR

    - command: shell.exec
      params:
        working_dir: src
        script: |
          set -e
          . ./compass_env.sh

          echo "Configuring npm..."
          cat <<EOT > .npmrc
          devdir=$NPM_CACHE_DIR/.node-gyp
          init-module=$NPM_CACHE_DIR/.npm-init.js
          cache=$NPM_CACHE_DIR
          tmp=$NPM_TMP_DIR
          _authToken=$NPM_AUTH_TOKEN
          EOT
    - command: shell.exec
      params:
        working_dir: src
        script: |
          set -e

          . ./compass_env.sh

          if [ -n "$IS_WINDOWS" ]; then
              echo "Installing nodejs v$NODE_JS_VERSION for windows..."
              curl -fs \
              -o ".deps/node-v$NODE_JS_VERSION-win-x64.zip" \
              --url "https://nodejs.org/download/release/v$NODE_JS_VERSION/node-v$NODE_JS_VERSION-win-x64.zip"
              cd .deps
              unzip node-v$NODE_JS_VERSION-win-x64.zip
              mv node-v$NODE_JS_VERSION-win-x64/* .
              rm -rf node-v$NODE_JS_VERSION-win-x64

              echo "Installing latest npm..."
              rm -rf npm npx npm.cmd npx.cmd
              mv node_modules/npm node_modules/npm2
              chmod +x ./node.exe
              ./node.exe node_modules/npm2/bin/npm-cli.js i -g npm@latest
              rm -rf node_modules/npm2/
              chmod +x npm.cmd npm
          else
              echo "Installing nodejs v$NODE_JS_VERSION for $PLATFORM..."
              curl -fs \
              -o ".deps/node-v$NODE_JS_VERSION-$PLATFORM-x64.tar.gz" \
              --url "https://nodejs.org/download/release/v$NODE_JS_VERSION/node-v$NODE_JS_VERSION-$PLATFORM-x64.tar.gz"
              cd .deps
              tar xzf node-v$NODE_JS_VERSION-$PLATFORM-x64.tar.gz --strip-components=1

              echo "Installing latest npm..."
              rm -rf npm npx
              mv lib/node_modules/npm lib/node_modules/npm2

              chmod +x ./bin/node
              ./bin/node lib/node_modules/npm2/bin/npm-cli.js i -g npm@latest
              rm -rf lib/node_modules/npm2/

              if [ -n "$IS_RHEL" ]; then
                echo "Installing native-addon depenendencies for RHEL..."
                #TODO (imlucas) Durran says these might be installed already by build team?
                # yum localinstall -y http://mirror.centos.org/centos/7/os/x86_64/Packages/libsecret-0.18.5-2.el7.x86_64.rpm
                # yum localinstall -y http://mirror.centos.org/centos/7/os/x86_64/Packages/libsecret-devel-0.18.5-2.el7.x86_64.rpm
              elif [ -n "$IS_UBUNTU" ]; then
                echo "Installing native-addon depenendencies for Ubuntu..."
                #TODO (imlucas) Durran says these might be installed already by build team?
                sudo apt-get install -y libsecret-1-dev
              fi
          fi

  'install':
    - command: shell.exec
      params:
        working_dir: src
        script: |
          set -e
          . ./compass_env.sh

          echo "Installing Compass dependencies..."
          npm ci

          if [ -n "$IS_WINDOWS" ]; then
            echo "Fetching signtool -> notary-service hack..."

            curl -fs \
              -o "signtool.exe" \
              --url "https://s3.amazonaws.com/boxes.10gen.com/build/signtool.exe"
            rm -f node_modules/electron-winstaller/vendor/signtool.exe
            chmod +x signtool.exe
          fi
  'save':
    - command: shell.exec
      params:
        script: |
          set -e
          tar -zcf compass-build.tgz ./src
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: compass-build.tgz
        remote_file: ${project}/${revision}/build.tgz
        bucket: mciuploads
        permissions: private
        content_type: application/octet-stream

  'restore':
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: compass-build.tgz
        remote_file: ${project}/${revision}/build.tgz
        bucket: mciuploads
        content_type: application/octet-stream
    - command: shell.exec
      params:
        script: |
          set -e
          tar xzf compass-build.tgz --strip-components=1
    - command: expansions.update
      params:
        file: src/expansions.yml

  'verify':
    command: shell.exec
    params:
      working_dir: src
      script: |
        set -e

        # Load environment variables
        . ./compass_env.sh

        echo "Run static analysis..."
        npm run check;

  'test':
    - command: shell.exec
      params:
        working_dir: src
        script: |
          set -e

          # Load environment variables
          . ./compass_env.sh

          set -e
          cat <<EOF_BUILD_SH > ~/compass_test.sh
          cd $(pwd)

          # Load environment variables
          . ./compass_env.sh

          MONGODB_VERSION=${mongodb_version|stable} npm test -- --${test_suite}
          EOF_BUILD_SH

          if $IS_OSX; then
            ssh -v -p 2222 localhost ". compass_test.sh"
          else
            . ~/compass_build.sh
          fi

  # package and published can now be looped by ${compass_distribution} 
  'package':
    - command: shell.exec
      params:
        working_dir: src
        script: |
          set -e
          # Load environment variables generated by `prepare`
          . ./compass_env.sh

          echo "Synchronizing evergreen environment from Compass build tools..."
          npm run evergreen-expansions ${compass_distribution} 
    - command: expansions.update
      params:
        file: src/expansions.yml
    - command: shell.exec
      params:
        working_dir: src
        script: |
          set -e
          cat <<EOF_BUILD_SH > ~/compass_package.sh
          cd $(pwd)

          # Load environment variables
          . ./compass_env.sh

          # Required to sign release assets
          export NOTARY_URL="http://notary-service.build.10gen.cc:5000"
          export NOTARY_AUTH_TOKEN="${signing_auth_token}"
          export NOTARY_SIGNING_KEY="${signing_key_name}"
          export NOTARY_SIGNING_COMMENT="Evergreen project mongodb/compass ${revision} - ${build_variant} - ${branch_name}"

          echo "Creating signed release build..."
          npm run release ${compass_distribution};
          EOF_BUILD_SH

          if $IS_OSX; then
            ssh -v -p 2222 localhost ". compass_package.sh"
          else
            . ~/compass_build.sh
          fi

  'publish':
    command: shell.exec
    params:
      working_dir: src
      script: |
        set -e

        # Load environment variables
        . ./compass_env.sh

        # Required to upload release assets to GitHub
        export GITHUB_TOKEN=${leafybot_github_token}

        # Required to upload release assets to s3 for download center
        export DOWNLOAD_CENTER_AWS_ACCESS_KEY_ID=${aws_key_evergreen_integrations}
        export DOWNLOAD_CENTER_AWS_SECRET_ACCESS_KEY=${aws_secret_evergreen_integrations}

        echo "Upload release assets to S3 and GitHub if needed"
        npm run upload ${compass_distribution}

  # NOTE (@imlucas) A ton of this can go away... use the generate tasks and stuff from migrator.
  # The actual uploads can be handled by `hadron-build` to S3 and then use
  # the `attach.results` evergreen command to show links on this page.
  'save windows artifacts':
    # setup
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/${windows_setup_filename}
        remote_file: ${project}/${revision}/${windows_setup_filename}
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
        display_name: windows-installer
    # MSI
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/${windows_msi_filename}
        remote_file: ${project}/${revision}/${windows_msi_filename}
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
        display_name: windows-msi-installer
    # ZIP
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/${windows_zip_filename}
        remote_file: ${project}/${revision}/${windows_zip_filename}
        bucket: mciuploads
        permissions: public-read
        content_type: application/zip
        display_name: windows-zip
    # RELEASES file
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/RELEASES
        remote_file: ${project}/${revision}/${compass_distribution}-RELEASES
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
        display_name: windows-auto-update-manifest
    # nupkg full
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/${windows_nupkg_full_filename}
        remote_file: ${project}/${revision}/${windows_nupkg_full_filename}
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
        display_name: windows-auto-update-payload

  'save osx artifacts':
    # .dmg
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/${osx_dmg_filename}
        remote_file: ${project}/${revision}/${osx_dmg_filename}
        bucket: mciuploads
        permissions: public-read
        content_type: 'application/x-apple-diskimage'
        display_name: macos-installer
    # .zip
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/${osx_zip_filename}
        remote_file: ${project}/${revision}/${osx_zip_filename}
        bucket: mciuploads
        permissions: public-read
        content_type: application/zip
        display_name: macos-auto-update-payload

  'save linux artifacts':
    # .deb
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/${linux_deb_filename}
        remote_file: ${project}/${revision}/${linux_deb_filename}
        bucket: mciuploads
        permissions: public-read
        content_type: 'application/vnd.debian.binary-package'
        display_name: linux-deb-installer
    # .tar.gz
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/${linux_tar_filename}
        remote_file: ${project}/${revision}/${linux_tar_filename}
        bucket: mciuploads
        permissions: public-read
        content_type: application/x-gzip
        display_name: linux-tarball

  'save rhel artifacts':
    # .rpm
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/${linux_rpm_filename}
        remote_file: ${project}/${revision}/${linux_rpm_filename}
        bucket: mciuploads
        permissions: public-read
        content_type: application/x-redhat-package-manager
        display_name: linux-rpm-installer
    # .tar.gz
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: src/dist/${linux_tar_filename}
        remote_file: ${project}/${revision}/${linux_tar_filename}
        bucket: mciuploads
        permissions: public-read
        content_type: application/x-gzip
        display_name: linux-rhel-tarball

tasks:
  - name: compile
    depends_on: []
    commands:
      - func: prepare
      - func: install
      - func: save

  - name: verify
    depends_on: [compile]
    tags: 
      - 'verify'
    commands:
      - func: restore
      - func: verify 

  - name: test-functional
    depends_on: [compile]
    tags: 
      - 'test'
    commands:
      - func: restore
      - func: test 
        vars:
          test_suite: functional

  - name: package-and-publish
    depends_on: .test
    commands:
      - func: restore
      - func: package
      - func: publish
      - func: 'save windows artifacts'
        variants: [windows]
      - func: 'save osx artifacts'
        variants: [macos]
      - func: 'save linux artifacts'
        variants: [ubuntu]   
      - func: 'save rhel artifacts'
        variants: [rhel]
  # NOTE (@imlucas) Examples of how to extend which tests run
  # and against which MongoDB Server version.
  # 
  # - name: test-renderer
  #   depends_on: [compile]
  #   tags: 
  #     - 'test'
  #   commands:
  #     - func: restore
  #     - func: test 
  #       vars:
  #         test_suite: renderer

  # - name: test-main
  #   depends_on: [compile]
  #   tags: 
  #     - 'test'
  #   commands:
  #     - func: restore
  #     - func: test 
  #       vars:
  #         test_suite: main

  # - name: test-enzyme
  #   depends_on: [compile]
  #   tags: 
  #     - 'test'
  #   commands:
  #     - func: restore
  #     - func: test 
  #       vars:
  #         test_suite: enzyme

  # - name: test-unit
  #   depends_on: [compile]
  #   tags: 
  #     - 'test'
  #   commands:
  #     - func: restore
  #     - func: test 
  #       vars:
  #         test_suite: unit
  #         mongodb_version: stable

  # - name: test-functional-unstable-server
  #   depends_on: [compile]
  #   tags: 
  #     - 'test'
  #   commands:
  #     - func: restore
  #     - func: test 
  #       vars:
  #         test_suite: functional
  #         mongodb_version: unstable

  # - name: test-functional-36x-server
  #   depends_on: [compile]
  #   tags: 
  #     - 'test'
  #   commands:
  #     - func: restore
  #     - func: test 
  #       vars:
  #         test_suite: functional
  #         mongodb_version: 3.6.x

  # - name: test-functional-34x-server
  #   depends_on: [compile]
  #   tags: 
  #     - 'test'
  #   commands:
  #     - func: restore
  #     - func: test 
  #       vars:
  #         test_suite: functional
  #         mongodb_version: 3.4.x
  
  # - name: test-functional-26x-server
  #   depends_on: [compile]
  #   tags: 
  #     - 'test'
  #   commands:
  #     - func: restore
  #     - func: test 
  #       vars:
  #         test_suite: functional
  #         mongodb_version: 2.6.x

# TODO determine OS/version deprecation policy, following server, so we don't fall behind
# what maximal resources we're using.
# See https://docs.google.com/document/d/1IfQGC7wTtrlsc2SqURirvt_4uMuU606nXNbu-stw6bQ/edit
buildvariants:
  - name: macos
    display_name: MacOS
    run_on: macos-1012
    tasks:
      - name: compile
        run_on: osx-1010-compass
      - name: test-functional
        run_on: macos-1012
      - name: 'package-and-publish'
        run_on: osx-1010-compass
        vars: 
          compass_distribution: compass
      - name: 'package-and-publish'
        run_on: osx-1010-compass
        vars: 
          compass_distribution: compass-community
      - name: 'package-and-publish'
        run_on: osx-1010-compass
        vars: 
          compass_distribution: compass-readonly
      - name: 'package-and-publish'
        run_on: osx-1010-compass
        vars: 
          compass_distribution: compass-isolated

  - name: windows
    display_name: Windows
    run_on: windows-64-vs2017-test
    expansions:
      compass_distribution: compass
    tasks:
      - name: compile
        run_on: windows-64-vs2017-compile
      - name: verify
      - name: test-functional
      # NOTE (@imlucas) See above for activating more tests
      # - name: test-unit
      # - name: test-main
      # - name: test-renderer
      # - name: test-enzyme    
      # - name: test-functional-unstable-server
      # - name: test-functional-36x-server
      # - name: test-functional-34x-server
      # - name: test-functional-26x-server
      - name: 'package-and-publish'
        run_on: windows-64-vs2017-compile
        vars: 
          compass_distribution: compass
      - name: 'package-and-publish'
        run_on: windows-64-vs2017-compile
        vars: 
          compass_distribution: compass-community
      - name: 'package-and-publish'
        run_on: windows-64-vs2017-compile
        vars: 
          compass_distribution: compass-readonly
      - name: 'package-and-publish'
        run_on: windows-64-vs2017-compile
        vars: 
          compass_distribution: compass-isolated

  - name: ubuntu
    display_name: Ubuntu
    run_on: ubuntu1404-test
    tasks:
      - name: compile
      - name: verify
      - name: test-functional
        run_on: ubuntu1804-test
      - name: 'package-and-publish'
        depends_on: '.test'
        vars: 
          compass_distribution: compass
      - name: 'package-and-publish'
        depends_on: '.test'
        vars: 
          compass_distribution: compass-community
      - name: 'package-and-publish'
        depends_on: '.test'
        vars: 
          compass_distribution: compass-readonly
      - name: 'package-and-publish'
        depends_on: '.test'
        vars: 
          compass_distribution: compass-isolated

  - name: rhel
    display_name: RHEL
    run_on: rhel70
    tasks:
      - name: compile
      - name: verify
      - name: test-functional
      - name: 'package-and-publish'
        depends_on: '.test'
        vars: 
          compass_distribution: compass
      - name: 'package-and-publish'
        depends_on: '.test'
        vars: 
          compass_distribution: compass-community
      - name: 'package-and-publish'
        depends_on: '.test'
        vars: 
          compass_distribution: compass-readonly
      - name: 'package-and-publish'
        depends_on: '.test'
        vars: 
          compass_distribution: compass-isolated